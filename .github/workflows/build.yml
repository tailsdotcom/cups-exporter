permissions:
  id-token: write # required to use OIDC authentication
  contents: read # required to checkout the code from the repo

name: Build Image and Push to ECR

# Only run one deployment at a time for a given branch
concurrency: ci-${{ github.ref }}

on:
  push:
  workflow_dispatch:

jobs:
  build_and_push:
    name: Build and Push Service container
    uses: tailsdotcom/actions/.github/workflows/build-container.yml@main
    with:
      aws_role: 426105708615:role/ci-cups-exporter
      image: 426105708615.dkr.ecr.eu-west-1.amazonaws.com/infrastructure-engineering/cups-exporter

  retag:
    name: Retag image
    needs: build_and_push
    uses: tailsdotcom/actions/.github/workflows/retag-image-from-branch.yml@main
    with:
      aws_role: 426105708615:role/ci-cups-exporter
      repository: infrastructure-engineering/cups-exporter
